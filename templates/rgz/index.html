{% extends "base.html" %}

{% block lab %}–†–∞—Å—á–µ—Ç–Ω–æ-–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ{% endblock %}

{% block main %}
    <style>
        table { border-collapse: collapse; width: 100%; margin: 20px 0; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        button { padding: 8px 12px; margin: 2px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
        .btn-add { background: #28a745; color: white; }
        .btn-del { background: #dc3545; color: white; }
        .btn-nav { background: #007bff; color: white; }
        .btn-nav:disabled { background: #ccc; cursor: not-allowed; }
        
        .panel { padding: 20px; border: 1px solid #ddd; background: #fff; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        #cart-panel { background: #e9ecef; border-color: #dee2e6; }
    </style>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>üì¶ –°–∫–ª–∞–¥ –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–∏</h1>
        <a href="/rgz/logout" style="color: red; font-weight: bold; text-decoration: none;">üö™ –í—ã—Ö–æ–¥</a>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="panel">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
        <input id="article" placeholder="–ê—Ä—Ç–∏–∫—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: TV-001)">
        <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <input id="quantity" type="number" min="1" placeholder="–ö–æ–ª-–≤–æ">
        <button onclick="addGood()" class="btn-add">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    
    <div style="display: flex; gap: 20px;">
        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div style="flex: 2;">
            <h3>üìã –¢–æ–≤–∞—Ä—ã (–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span id="page-num">1</span>)</h3>
            <button id="prevBtn" onclick="changePage(-1)" class="btn-nav" disabled>‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
            <button id="nextBtn" onclick="changePage(1)" class="btn-nav">–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è</button>
            
            <table id="goodsTable">
                <thead>
                    <tr><th>ID</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                </thead>
                <tbody id="goodsBody"></tbody>
            </table>
        </div>
        
        <!-- –ö–æ—Ä–∑–∏–Ω–∞ –∏ –ó–∞–∫–∞–∑—ã -->
        <div style="flex: 1;">
            <div id="cart-panel" class="panel">
                <h3>üõí –ö–æ—Ä–∑–∏–Ω–∞</h3>
                <div id="cartItems">–ü—É—Å—Ç–æ</div>
                <hr>
                <button onclick="createOrder()" id="createOrderBtn" class="btn-add" style="width: 100%; display: none;">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
            
            <div class="panel">
                <h3>üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
                <button onclick="loadOrders()" style="width: 100%; margin-bottom: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="ordersList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let cart = {}; 

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API
        async function apiCall(method, params = {}) {
            const response = await fetch('/rgz/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jsonrpc: '2.0', method: method, params: params, id: Date.now() })
            });
            const data = await response.json();
            if (data.error) {
                alert('–û—à–∏–±–∫–∞ API: ' + data.error.message);
                return null;
            }
            return data.result;
        }

        // --- –¢–û–í–ê–†–´ ---
        async function loadGoods(page) {
            const data = await apiCall('Goods.get_list', { page: page, per_page: 5 }); // –ò–º—è –º–µ—Ç–æ–¥–∞ –∫–∞–∫ –≤ app.py!
            if (!data) return;

            const tbody = document.getElementById('goodsBody');
            tbody.innerHTML = '';
            
            data.items.forEach(g => {
                tbody.innerHTML += `
                    <tr>
                        <td>${g.id}</td>
                        <td>${g.article}</td>
                        <td>${g.name}</td>
                        <td><b>${g.quantity}</b></td>
                        <td>
                            <button onclick="addToCart(${g.id}, '${g.name}')" class="btn-nav">üõí</button>
                            <button onclick="deleteGood(${g.id})" class="btn-del">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });

            currentPage = data.page;
            document.getElementById('page-num').innerText = currentPage;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= data.pages;
        }

        async function addGood() {
            const article = document.getElementById('article').value;
            const name = document.getElementById('name').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            
            if (!article || !name || !quantity) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            await apiCall('Goods.add', { article, name, quantity });
            loadGoods(currentPage);
            document.getElementById('article').value = '';
            document.getElementById('name').value = '';
            document.getElementById('quantity').value = '';
        }

        async function deleteGood(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
                await apiCall('Goods.delete', { id: id });
                loadGoods(currentPage);
            }
        }

        function changePage(delta) {
            loadGoods(currentPage + delta);
        }

        // --- –ö–û–†–ó–ò–ù–ê ---
        function addToCart(id, name) {
            if (!cart[id]) cart[id] = { name: name, qty: 0 };
            cart[id].qty++;
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const btn = document.getElementById('createOrderBtn');
            container.innerHTML = '';
            
            const items = Object.entries(cart);
            if (items.length === 0) {
                container.innerHTML = '–ü—É—Å—Ç–æ';
                btn.style.display = 'none';
                return;
            }

            items.forEach(([id, item]) => {
                container.innerHTML += `
                    <div style="margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                        <b>${item.name}</b>: ${item.qty} —à—Ç.
                        <button onclick="cart[${id}].qty = 0; delete cart[${id}]; renderCart()" style="font-size: 10px; color: red;">‚ùå</button>
                    </div>`;
            });
            btn.style.display = 'block';
        }

        // --- –ó–ê–ö–ê–ó–´ ---
        async function createOrder() {
            const items = Object.entries(cart).map(([id, val]) => ({ good_id: parseInt(id), qty: val.qty }));
            await apiCall('Order.create', { items: items });
            
            cart = {}; // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
            renderCart();
            alert('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!');
            loadOrders();
        }

        async function loadOrders() {
            const orders = await apiCall('Orders.get_list');
            const container = document.getElementById('ordersList');
            container.innerHTML = '';

            orders.reverse().forEach(o => {
                const statusColor = o.status === '–æ–ø–ª–∞—á–µ–Ω' ? 'green' : 'orange';
                const payBtn = o.status === '–Ω–µ–æ–ø–ª–∞—á–µ–Ω' 
                    ? `<button onclick="payOrder(${o.id})" style="background: #ffc107;">üí∞ –û–ø–ª–∞—Ç–∏—Ç—å</button>` 
                    : '';

                container.innerHTML += `
                    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 5px; background: #fff;">
                        <div><b>–ó–∞–∫–∞–∑ #${o.id}</b> (<span style="color:${statusColor}">${o.status}</span>)</div>
                        <div style="font-size: 12px; color: gray;">${o.created_at}</div>
                        ${payBtn}
                    </div>`;
            });
        }

        async function payOrder(id) {
            await apiCall('Order.pay', { id: id });
            loadOrders();
            loadGoods(currentPage); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        loadGoods(1);
        loadOrders();
    </script>
{% endblock %}
